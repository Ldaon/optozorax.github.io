---
layout: post
title:  "Эволюция виртуальных существ (перевод видео 1994 года)"
tags: ютуб эволюция
permalink: evolved-virtual-creatures
description: "Привожу источники информации и объясняю как это работает."
toc: true
image: /assets/img/evolution.png
vk: nothing there
hide: true 
---

# Введение

Случайно встретил на просторах интернета этот занимательный видос, и мне он настолько понравился, что я решил поделиться им с русским зрителем: перевести и озвучить. Результат опубликовал на ютуб:

<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/JBgG_VSP7f8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</center>

К сожалению при переводе пришлось пойти на компромиссы, поэтому смысл в некоторых местах может быть немного искажён.

Далее я приведу ссылки и немного подробнее расскажу об том, как это работает.

# Ссылки

* [Оригинал](https://archive.org/details/sims_evolved_virtual_creatures_1994) видео на сайте archive.org.
* [Страница](http://www.karlsims.com/evolved-virtual-creatures.html) на сайте Карла Симса об этом проекте.
* [Научная статья](http://www.karlsims.com/papers/alife94.pdf) об этой работе, её можно найти на странице выше.
* Немного дополненная [статья](http://www.karlsims.com/papers/siggraph94.pdf) для конференции SIGGRAPH. Крайне рекомендую прочитать, в ней нет никаких сложных формул, только идеи и результаты. Плюс в ней больше информации, чем в статье выше. Всё описание далее основывается на этой статье.
* [Видео](https://www.youtube.com/watch?v=WmrTNrtE-Lk), где тоже самое, что и в оригинальном видео рассказывает сам Карл. Никакой особо новой информации там нет, но на всякий случай пусть будет.
* [Патент #5511158](https://patents.google.com/patent/US5511158?oq=5511158), где подробно рассказывается о том, как создавать и мутировать направленные графы, на основе которых строится тело и мозг существ.

# Эволюция

Кто не понял, в этом видео показываются результаты, полученные путём симуляции эволюции для неких существ в симулируемой физической среде. Лучшие существа отбирались в соответствии с эффективностью решения своих задач. Например, в самом начале говорят что для существ использовалась скорость плавания как критерий для отбора. Все существа эволюционировали независимо, каждое умеет выполнять только свою задачу, там нет того, кто бы делал все три.

Предполагаю, что читатель данной статьи знаком с тем, как работает эволюция или `генетический алгоритм`, и особо об этом рассказывать не надо. Если же нет, то срочно бегите смотреть [это](https://youtu.be/dN_6B1auRV4) или [это](https://youtu.be/SfEZSyvbj2w) видео. А вообще я планирую в ближайшее время собрать множество материалов по симуляции эволюции, так что подписывайтесь на группу в ВК.

# 1994 год, серьёзно?

Я тоже был невероятно удивлен! Получены отличные результаты, и удивительно, что в то время вообще могли помыслить об симуляции 3D существ. Я бы предпочел симулировать 2D ввиду ограниченной вычислительной мощности тех времён.

Тем более, судя по теням и картинкам на сайте, для визуализации использовали [рейтрейсинг](https://ru.wikipedia.org/wiki/%D0%A2%D1%80%D0%B0%D1%81%D1%81%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B0_%D0%BB%D1%83%D1%87%D0%B5%D0%B9), тоже очень требовательный к вычислениям метод.

Согласно научной статье, программа вычислялась на суперкомпьютере [CM-5](https://en.wikipedia.org/wiki/Connection_Machine), который, на минуточку, в 1993 году был первым в списке [TOP500](https://en.wikipedia.org/wiki/TOP500).

Так же в статье приведен пример времени работы программы: при размере популяции в 300 особей, обработка 100 поколений на 32 ядрах этого компьютера занимала 3 часа. Мне кажется, в 2019 наши домашние ПК могут работать с такой же скоростью для подобной программы.

К сожалению, далее Карл Симс, если изучить его сайт, не занимался этой темой.

Зато занимался чем-то подобным ранее:

<center>
<iframe width="560" height="315" src="https://www.youtube.com/embed/aUdCS1lLiYs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</center>

# Устройство существа

У данных существ мозг и тело идейно связаны, поэтому нельзя объяснить принцип устройства одного без объяснения принципа устройства другого.

Существо состоит из жестких кубоидов (параллелепипедов), соединенных шарнирами.

Этот внешний вид строится на основе генетического кода, который является направленным графом, описывающим какие части могут соединяться с какими и в каких местах.

Ниже на изображении пример генов и результирующих существ. Обратите внимание на то, что некоторые части могут строиться рекурсивно.

![](/assets/img/graph_creature.png)

На данной картинке разные части подписаны для удобства, это лишь рукотворный пример.

Каждая вершина содержит иформацию:
* Отностиельный размер параллелепипеда.
* Ограничения на рекурсивность данной части тела (если она ссылается сама на себя).
* Локальная нейронная сеть.

Каждое ребро графа содержит информацию:
* Тип шарнира, связующего две части: закрепленный, свободный, вокруг определенной оси, и другие которые я не понял (revolute, twist, universal, bend-twist, twist-bend).
* Ограничения на вращение.
* Под каким углом расположено соединение.

## Устройство мозга

Современные нейросети представляют собой жесткую линейную архитектуру (в виде ацикличного ориентированного графа), и иногда рекуррентную. В данной же работе никаких таких ограничений нет, и любой нейрон может связываться с любым другим нейроном, единственное условие - чтобы граф был связным. Части, не принадлежащие основному графу, удаляются сборщиком мусора.

Так же в современных нейросетях все числа на входе умножаются на некоторую константу и складываются, главное различие только в функции активации. В этой же работе реализованы произвольные функции над входными данными, даже умножение и деление. Но для деления есть ограничения на количество входных параметров. А для всех функций количество входных параметров не более трех. Список всех функций:
* sum
* product
* divide
* sum-threshold
* greater-than
* sign-of
* min
* max
* abs
* if
* interpolate
* sin
* cos
* atan
* log
* expt
* sigmoid
* integrate
* differentiate
* smooth
* memory
* oscillate-wave
* oscillate-saw

К сожалению я знаю о том, как работают эти функции не больше вашего, и нам остается только догадываться.

Некоторые функции не просто вычисляют ответ на основе своих входных данных, но ещё и хранят некоторое внутреннее состояние. 

Аналогично обычным НС, здесь каждый вход умножается на какое-то число. На вход даже может подаваться константа.

Наиболее интересными мне показались функции для осцилляции, благодаря им можно заставить существо двигать частями тела, когда внешние сигналы особо не поступают. Это как будто включился режим "двигаться", когда выполнилось некоторое условие.

На каждую итерацию симуляции приходится две итерации движения сигнала в нейронной сети.

## Входные параметры

У каждой локальной нейронной сети есть входы для своей физической части:

* **Угол наклона соединения** - передается отдельным нейроном для каждого соединения.
* **Сенсор касания** - аналогично для каждой грани создаётся отдельный нейрон. Передаёт 1, если контакт есть, и -1, если нет.
* **"Фотосенсор"**, для каждой части имеется своя копия. Передает нормализованный относительный вектор направления на источник света или зелёный куб. Название взято в кавычки, потому что настоящее явление света не симулируется, и существо видит свет, даже если по факту оно загорожено другими объектами.

В своей работе Карл Симс говорит, что в качестве сенсоров было бы интересно использовать: акселерометры, [проприорецепторы](https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D0%BF%D1%80%D0%B8%D0%BE%D1%80%D0%B5%D1%86%D0%B5%D0%BF%D1%82%D0%BE%D1%80), детекторы запаха и звука. Но в его работе ничего такого не используется, потому что уже имеющихся достаточно для получения интересного поведения.

## Выходные параметры

* 
## Взаимодействие локальный нейронных сетей

Вообще идея распространять на каждую часть тела свою локальную нейронную сеть звучит мега-круто, например можно создать одину НС для части хвоста существа на 27 секунде видео. В итоге каждая часть будет двигаться единообразно, и такое существо можно легко расширить или уменьшить, или добавить ему пару хвостов.

Вот

## Устройство нейронной сети

Нейронная сеть представлена в виде ориентированного графа. Причем в нём могут присутствовать другие, вложенные графы.

# Устройство тела

Аналогично мозгу, тело строится на основе графовых структур.

...

Кстати, внимательнлый читатель может заметить, что если вдруг произойдет мутация тела, а именно: добавиться новая часть, то далее существу придётся эволюционировать так, чтобы в мозг добавились соответствующие нейроны для этой части. Но Карл Симс заранее подумал об этой проблеме и придумал что для каждой части тела уже заранее есть некоторый набор нейронных структур, которые просто добавляются в мозг, и в нём же далее просто как-то соединяются. Именно это он и называет вложенными графами в своей работе.

# Размножение

В 40% случаях осуществляется простое копирование существа с применение мутации, в 30% случаях скрещивание под названием `crossovers`, и в 30% оставшихся случаев скрещивание под названием `grafting`. За подробностями обращайтесь к оригинальной научной статье, я же не хочу это расписывать из-за слишком большой сложности, да и не очень-то верю, что скрещивание хоть на что-то влияет.

# "Успешное поведение сильно зависит от противника."

Когда я услышал эту фразу, на меня сразу нашло озарение, что вот она золотая жила бесконечно увеличивающейся сложности для эволюции: сражения между двумя соперниками! Можно сначала натаскать двух соперников сильно друг против друга, а затем поменять их всех друг между другом, и снова эволюционировать, и так повторять до бесконечности, и получать очень интересных существ!

Просто обычно симуляция эволюции представляет собой подобный график:

![](/assets/img/fitness_function.png)

Взято [отсюда](https://www.researchgate.net/publication/221472180_Skin_Lesion_Diagnosis_Using_Fluorescence_Images).

Фитнес-функция - это функция, которая оценивает эффективность решения особью поставленной задачи. Как видим из графика, в процессе эволюции значение этой функции растет, а затем сходится к какому-то пределу и далее не изменяется.

Это является одной из главных проблем в эволюционных алгоритмах - как заставить эволюцию протекать таким образом, чтобы у существ постоянно возрастала сложность, чтобы они решали задачу лучше и лучше, и чтобы в пределе мы могли запустить эволюцию на суперкомпьютере, оставить на пару лет и получить скайнет. :)

По моим предположениям одним из таких двигателей постоянно возрастающей сложности может стать соревновательная система, представленная в видео. В ней успех существа не зависит от среды, и не является какой-то статичной функцией, которая может к чему-то сойтись, нет, она зависит от постоянно меняющегося противника, который меняется в зависимости от своего оппонента. 

Но интуиция прожённого прагматика подсказывает мне, что нет, не будет эта система сходиться к сложным и эффективным решениям. Надеюсь, что она ошибается.

Кстати, в работе показываются и обсуждаются различные соревновательные системы, как между существами одной популяции, так и между двумя:

![](/assets/img/tournaments.png)

# Future work

В этом разделе своей работы автор предлагает развить эту идею до симуляции целых экосистем, где одновременно находится множество существ, которые могут не только соревноваться, но и объединяться.

К сожалению, учитывая ту информацию, что я нагуглил, ничего путного из этого не вышло. :( 

Например, в [этом](https://www.youtube.com/watch?v=_m97_kL4ox0) видео о программе [Polyworld](https://en.wikipedia.org/wiki/Polyworld) обсуждается система, похожая на эволюцию виртуальных существ, но уже с полноценной симуляцией экосистемы, где по идее существа должны придумывать сложное поведение. Результаты печальные: никакого сложного поведения не возникало, сложность мозга в итоге сошлась к какому-то пределу, и в самом видео автор серьезно поднимает эту тему. Кстати именно отсюда я и узнал про существование видео Карла Симса. :)

![](/assets/img/neural_complexity.png)

# Маленькая размерность

Наивный читатель может подумать, что можно поставить перед существами требование выполнять какие-то сверх-сложные операции, по типу получать изображение с камеры и на основе него ходить при помощи ног, поставить эволюцию на супер-компьютер и получить какой-то результат, а в потенциале и сильный ИИ.

К сожалению нет, эволюция отлично работает на маленьких размерностях мозга и поведения, но при большой размерности мы вряд ли сможем получить что-то адекватное, или вообще сойтись к решению. Я такими данными не располагаю, просто уверен в этом. Да и если бы на самом деле такое было бы возможно, уже бы давно в современных играх были бы NPC на основе тех же самых нейронных сетей, что описал Карл Симс, но к сожалению такого даже близко не видно, все NPC пишутся вручную на [конечных автоматах](https://tproger.ru/translations/finite-state-machines-theory-and-implementation/), а движение их ног задаётся обычными анимациями вместо адаптивного движения.